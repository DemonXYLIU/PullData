# 快速开始指南

## 安装依赖

```bash
pip3 install pymysql
```

## 使用示例

### 示例 1: 日常增量同步所有表

```bash
cd /Users/demon/Downloads/PullData
python3 sync.py
```

**输出示例:**
```
正在获取表清单...
📋 发现 156 张表
🔧 同步模式: 智能同步(增量/全量)
⚙️  并发线程数: 8
============================================================
🚀 mt_part: 增量同步 (2025-12-08 10:30:00 -> 2025-12-09 09:15:00) [✅ 成功]
🚀 mt_bom: 增量同步 (2025-12-08 10:30:00 -> 2025-12-09 09:15:00) [✅ 成功]
🔄 sys_config: 全量同步 (无 editTime) [✅ 成功]
⏹️  mt_classification: 无新数据 (Current: 2025-12-08 10:30:00)
============================================================
🎉 所有任务结束。
```

---

### 示例 2: 对单个表进行全量同步

假设 `mt_part` 表数据有问题,需要重新全量同步:

```bash
python3 sync.py --tables mt_part --full
```

**输出示例:**
```
📋 用户指定 1 张表: mt_part
✅ 将同步以下有效表: mt_part
🔧 同步模式: 强制全量同步
⚙️  并发线程数: 8
============================================================
🔄 mt_part: 强制全量同步 [✅ 成功]
============================================================
🎉 所有任务结束。
```

---

### 示例 3: 对多个表进行全量同步

新增了几个表,需要首次全量同步:

```bash
python3 sync.py --tables mt_part mt_bom mt_classification mt_document --full
```

**输出示例:**
```
📋 用户指定 4 张表: mt_part, mt_bom, mt_classification, mt_document
✅ 将同步以下有效表: mt_part, mt_bom, mt_classification, mt_document
🔧 同步模式: 强制全量同步
⚙️  并发线程数: 8
============================================================
🔄 mt_part: 强制全量同步 [✅ 成功]
🔄 mt_bom: 强制全量同步 [✅ 成功]
🔄 mt_classification: 强制全量同步 [✅ 成功]
🔄 mt_document: 强制全量同步 [✅ 成功]
============================================================
🎉 所有任务结束。
```

---

### 示例 4: 所有表全量同步 ⭐⭐

数据库迁移、灾难恢复或环境复制时,需要对所有表进行全量同步:

```bash
python3 sync.py --full
```

**输出示例:**
```
正在获取表清单...
📋 发现 156 张表
🔧 同步模式: 强制全量同步
⚙️  并发线程数: 8
============================================================
🔄 mt_part: 强制全量同步 [✅ 成功]
🔄 mt_bom: 强制全量同步 [✅ 成功]
🔄 mt_classification: 强制全量同步 [✅ 成功]
🔄 mt_document: 强制全量同步 [✅ 成功]
... (更多表)
============================================================
🎉 所有任务结束。
```

> ⚠️ **警告**: 此操作会对所有表进行全量同步,可能需要较长时间,请在非高峰期执行!

---

### 示例 5: 排除指定表 ⭐

排除不需要同步的日志表、临时表等:

```bash
python3 sync.py --exclude sys_log sys_temp audit_log
```

**输出示例:**
```
正在获取表清单...
📋 发现 156 张表
🚫 排除 3 张表: sys_log, sys_temp, audit_log
✅ 实际同步 153 张表 (原 156 张)
🔧 同步模式: 智能同步(增量/全量)
⚙️  并发线程数: 8
============================================================
🚀 mt_part: 增量同步 (2025-12-08 10:30:00 -> 2025-12-09 09:15:00) [✅ 成功]
🚀 mt_bom: 增量同步 (2025-12-08 10:30:00 -> 2025-12-09 09:15:00) [✅ 成功]
... (更多表)
============================================================
🎉 所有任务结束。
```

> 💡 **提示**: 可以大幅减少同步时间和数据量,适合排除历史日志、临时数据等。

---

### 示例 6: 对指定表进行增量同步

只想同步几个特定的表(增量模式):

```bash
python3 sync.py --tables mt_part mt_bom
```

**输出示例:**
```
📋 用户指定 2 张表: mt_part, mt_bom
✅ 将同步以下有效表: mt_part, mt_bom
🔧 同步模式: 智能同步(增量/全量)
⚙️  并发线程数: 8
============================================================
🚀 mt_part: 增量同步 (2025-12-08 10:30:00 -> 2025-12-09 09:15:00) [✅ 成功]
🚀 mt_bom: 增量同步 (2025-12-08 10:30:00 -> 2025-12-09 09:15:00) [✅ 成功]
============================================================
🎉 所有任务结束。
```

---

### 示例 7: 使用简写参数

```bash
# -t 是 --tables 的简写
# -f 是 --full 的简写
# -e 是 --exclude 的简写
python3 sync.py -t mt_part mt_bom -f
python3 sync.py -e sys_log sys_temp
```

---

### 示例 6: 表名不存在时的处理

如果指定的表名不存在,工具会自动过滤:

```bash
python3 sync.py --tables mt_part non_existent_table mt_bom --full
```

**输出示例:**
```
📋 用户指定 3 张表: mt_part, non_existent_table, mt_bom
⚠️  警告: 以下表不存在: non_existent_table
✅ 将同步以下有效表: mt_part, mt_bom
🔧 同步模式: 强制全量同步
⚙️  并发线程数: 8
============================================================
🔄 mt_part: 强制全量同步 [✅ 成功]
🔄 mt_bom: 强制全量同步 [✅ 成功]
============================================================
🎉 所有任务结束。
```

---

## 定时任务配置

### 使用 crontab 设置定时同步

```bash
# 编辑 crontab
crontab -e

# 添加以下行(每天凌晨 2 点执行增量同步)
0 2 * * * cd /Users/demon/Downloads/PullData && python3 sync.py >> sync.log 2>&1

# 每小时执行一次增量同步
0 * * * * cd /Users/demon/Downloads/PullData && python3 sync.py >> sync.log 2>&1

# 每周日凌晨 3 点对重要表进行全量同步
0 3 * * 0 cd /Users/demon/Downloads/PullData && python3 sync.py -t mt_part mt_bom -f >> sync_full.log 2>&1
```

---

## 故障排查

### 查看错误日志

如果某个表同步失败,会生成错误日志文件:

```bash
# 查看错误日志
cat error_mt_part.log

# 查看最近的错误
tail -n 50 error_mt_part.log
```

### 重置 checkpoint

如果需要重置某个表的 checkpoint:

**方法 1: 使用 --full 参数(推荐)**
```bash
python3 sync.py --tables mt_part --full
```

**方法 2: 手动编辑 checkpoint.json**
```bash
# 编辑 checkpoint.json
vi checkpoint.json

# 删除对应表的记录,例如:
{
    "mt_part": "2025-12-09 09:15:00",  # 删除这行
    "mt_bom": "2025-12-09 09:15:00"
}
```

---

## 性能优化建议

### 调整并发线程数

根据服务器性能调整 `MAX_WORKERS`:

```python
# 在 sync.py 中修改
MAX_WORKERS = 16  # 增加到 16 个线程(适合高性能服务器)
MAX_WORKERS = 4   # 减少到 4 个线程(适合低配置服务器)
```

### 调整 DataX 通道数

在 `sync.py` 中修改 DataX 配置:

```python
"setting": {
    "speed": {"channel": 10}  # 增加通道数以提高速度
}
```

---

## 常见使用场景

| 场景 | 命令 | 说明 |
|------|------|------|
| 日常增量同步 | `python3 sync.py` | 同步所有表,自动增量 |
| **所有表全量同步** | `python3 sync.py --full` | **数据库迁移/灾难恢复** |
| **排除日志表** | `python3 sync.py -e sys_log sys_temp` | **减少同步时间和数据量** |
| 数据修复 | `python3 sync.py -t mt_part -f` | 重新全量同步单表 |
| 新表初始化 | `python3 sync.py -t new_table -f` | 新表首次全量同步 |
| 批量重置 | `python3 sync.py -t t1 t2 t3 -f` | 多表全量同步 |
| 指定表增量 | `python3 sync.py -t mt_part mt_bom` | 只同步指定表 |
| 查看帮助 | `python3 sync.py --help` | 显示帮助信息 |

---

## 下一步

- 查看 [README.md](README.md) 了解详细功能说明
- 根据实际需求调整配置参数
- 设置定时任务实现自动化同步
