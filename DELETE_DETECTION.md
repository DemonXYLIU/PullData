# 删除数据识别功能说明

## 🎯 功能概述

删除数据识别功能解决了传统 REPLACE 模式无法处理删除操作的问题,确保目标库数据与源库完全一致。

### 问题背景

**传统 REPLACE 模式的问题:**
- ✅ 能处理新增数据(INSERT)
- ✅ 能处理更新数据(UPDATE)  
- ❌ **无法处理删除数据(DELETE)**

**示例:**
```
源表 T1: [1, 2, 3, 4, 5]
源表 T2: 删除记录 3 -> [1, 2, 4, 5]

传统同步结果:
目标表 T2: [1, 2, 3, 4, 5]  ❌ 记录 3 仍然存在!

新功能同步结果:
目标表 T2: [1, 2, 4, 5]  ✅ 记录 3 已删除!
```

## 📝 使用方法

### 1. 默认行为(启用删除检测)

```bash
# 增量同步,自动检测并删除多余记录
python3 sync.py

# 指定表同步,启用删除检测
python3 sync.py --tables mt_part mt_bom
```

### 2. 禁用删除检测

```bash
# 如果不需要删除检测,可以禁用
python3 sync.py --no-detect-deletes
```

### 3. 全量同步 + 清空表

```bash
# 全量同步前先清空目标表,确保数据完全一致
python3 sync.py --full --truncate-before-sync

# 对指定表进行全量同步并清空
python3 sync.py --tables mt_part --full --truncate-before-sync
```

## 🔍 工作原理

### 增量同步模式

1. **同步增量数据**: 使用 DataX 同步新增和更新的数据
2. **获取主键**: 查询表的主键字段
3. **对比主键**: 
   - 获取源表所有主键值
   - 获取目标表所有主键值
   - 计算差集(目标表有但源表没有的)
4. **删除多余记录**: 删除目标表中多余的记录
5. **更新 checkpoint**: 更新同步检查点

### 全量同步 + 清空表模式

1. **清空目标表**: TRUNCATE TABLE(可选)
2. **全量同步**: 同步源表所有数据
3. **更新 checkpoint**: 更新同步检查点

> 💡 **提示**: 全量同步 + 清空表模式不需要删除检测,因为表已清空

## 📊 输出示例

### 启用删除检测

```
正在获取表清单...
📋 发现 156 张表
🔧 同步模式: 智能同步(增量/全量)
🔍 删除检测: 启用
⚙️  并发线程数: 8
============================================================
🚀 mt_part: 增量同步 (2025-12-08 10:30:00 -> 2025-12-09 09:15:00) (删除 3 条) [✅ 成功]
🚀 mt_bom: 增量同步 (2025-12-08 10:30:00 -> 2025-12-09 09:15:00) [✅ 成功]
🔄 sys_config: 全量同步 (无 editTime) (无主键,跳过删除检测) [✅ 成功]
============================================================
🎉 所有任务结束。
```

### 全量同步 + 清空表

```
📋 用户指定 1 张表: mt_part
✅ 将同步以下有效表: mt_part
🔧 同步模式: 强制全量同步
🔍 删除检测: 启用
🗑️  清空表模式: 启用(全量同步前清空表)
⚙️  并发线程数: 8
============================================================
🔄 mt_part: 强制全量同步 (已清空目标表) [✅ 成功]
============================================================
🎉 所有任务结束。
```

## 🎯 适用场景

### 场景 1: 日常增量同步

确保目标库与源库数据完全一致:

```bash
# 每天定时同步,自动删除已删除的记录
python3 sync.py
```

### 场景 2: 数据修复

某个表数据不一致,需要重新全量同步:

```bash
# 清空表后全量同步,确保数据完全一致
python3 sync.py --tables problematic_table --full --truncate-before-sync
```

### 场景 3: 数据库迁移

迁移数据库时确保数据完全一致:

```bash
# 全量同步所有表,清空后同步
python3 sync.py --full --truncate-before-sync
```

### 场景 4: 性能优先场景

如果确定不需要删除检测(例如只有新增数据):

```bash
# 禁用删除检测以提高性能
python3 sync.py --no-detect-deletes
```

## ⚙️ 参数说明

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `--no-detect-deletes` | 禁用删除检测 | 启用 |
| `--truncate-before-sync` | 全量同步前清空表 | 禁用 |

## ⚠️ 注意事项

### 1. 主键要求

- **有主键的表**: 正常进行删除检测
- **无主键的表**: 跳过删除检测,显示警告

```
🔄 sys_config: 全量同步 (无 editTime) (无主键,跳过删除检测) [✅ 成功]
```

### 2. 性能影响

删除检测需要额外的查询操作:
- 查询源表所有主键
- 查询目标表所有主键
- 对比并删除多余记录

**性能影响**: 通常增加 10%-30% 的同步时间

**优化建议**:
- 对于超大表(百万级以上),可以考虑使用 `--truncate-before-sync`
- 对于确定没有删除操作的表,可以使用 `--no-detect-deletes`

### 3. 数据安全

- **清空表操作**: `--truncate-before-sync` 会清空目标表,请谨慎使用
- **删除操作**: 删除检测会物理删除记录,无法恢复
- **建议**: 重要数据库操作前先备份

### 4. 并发安全

- 删除检测在同步完成后执行
- 使用事务确保数据一致性
- 多线程并发时每个表独立处理

## 📈 性能对比

假设表有 10 万条记录,源表删除了 100 条:

### 不启用删除检测

```bash
python3 sync.py --no-detect-deletes
```

- 同步时间: 30 秒
- 结果: 目标表有 10 万条记录(多 100 条)
- 数据一致性: ❌ 不一致

### 启用删除检测(默认)

```bash
python3 sync.py
```

- 同步时间: 35 秒(增加 5 秒)
- 结果: 目标表有 9.99 万条记录
- 数据一致性: ✅ 完全一致

### 全量同步 + 清空表

```bash
python3 sync.py --full --truncate-before-sync
```

- 同步时间: 40 秒
- 结果: 目标表有 9.99 万条记录
- 数据一致性: ✅ 完全一致

## 🧪 测试验证

### 自动化测试

运行测试脚本:

```bash
python3 test_delete_detection.py
```

测试流程:
1. 创建测试表
2. 插入初始数据(5 条)
3. 从源表删除 2 条记录
4. 运行同步(启用删除检测)
5. 验证目标表数据与源表一致
6. 清理测试数据

### 手动测试

```sql
-- 1. 创建测试表
CREATE TABLE test_sync (
    id INT PRIMARY KEY,
    name VARCHAR(50),
    editTime DATETIME
);

-- 2. 源表插入数据
INSERT INTO test_sync VALUES (1, 'A', NOW()), (2, 'B', NOW()), (3, 'C', NOW());

-- 3. 首次同步
-- python3 sync.py --tables test_sync --full

-- 4. 删除源表数据
DELETE FROM test_sync WHERE id = 2;

-- 5. 增量同步(启用删除检测)
-- python3 sync.py --tables test_sync

-- 6. 验证目标表
SELECT * FROM test_sync;  -- 应该只有 id=1 和 id=3
```

## 🔧 高级用法

### 1. 组合使用

```bash
# 全量同步指定表,排除日志表,清空后同步
python3 sync.py --full --exclude sys_log --truncate-before-sync

# 增量同步,排除某些表,禁用删除检测
python3 sync.py --exclude sys_temp --no-detect-deletes
```

### 2. 定时任务

```bash
# 每天凌晨 2 点增量同步,启用删除检测
0 2 * * * cd /path/to/PullData && python3 sync.py >> sync.log 2>&1

# 每周日凌晨 3 点全量同步并清空表
0 3 * * 0 cd /path/to/PullData && python3 sync.py --full --truncate-before-sync >> sync_full.log 2>&1
```

## ❓ 常见问题

### Q1: 删除检测会误删数据吗?

A: 不会。删除检测只删除"目标表有但源表没有"的记录,确保目标表与源表一致。

### Q2: 如果表没有主键怎么办?

A: 会跳过删除检测并显示警告。建议为表添加主键以启用删除检测。

### Q3: 删除检测会影响性能吗?

A: 会有一定影响,通常增加 10%-30% 的同步时间。对于超大表可以考虑使用 `--truncate-before-sync`。

### Q4: 可以只对某些表启用删除检测吗?

A: 当前版本是全局设置。如需单独控制,可以分两次运行:
```bash
# 对需要删除检测的表
python3 sync.py --tables table1 table2

# 对不需要删除检测的表
python3 sync.py --tables table3 table4 --no-detect-deletes
```

### Q5: 清空表模式会删除所有数据吗?

A: 是的,`--truncate-before-sync` 会清空目标表,然后重新同步。请谨慎使用。

## 🎉 总结

**删除数据识别功能**确保了数据的完全一致性:

✅ **自动检测**: 默认启用,无需额外配置  
✅ **灵活控制**: 可以禁用或使用清空表模式  
✅ **性能优化**: 支持多种模式适应不同场景  
✅ **安全可靠**: 基于主键对比,确保准确性  

**推荐使用方式**:
- **日常同步**: 使用默认设置(启用删除检测)
- **数据修复**: 使用 `--full --truncate-before-sync`
- **性能优先**: 使用 `--no-detect-deletes`

**核心命令**:
```bash
# 默认(推荐)
python3 sync.py

# 全量同步 + 清空表
python3 sync.py --full --truncate-before-sync
```
