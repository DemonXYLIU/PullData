# 所有表全量同步功能说明

## 🎯 功能概述

新增了**所有表全量同步**功能,允许您一次性对数据库中的所有表进行强制全量同步。

## 📝 使用方法

### 基本用法

```bash
# 对所有表进行全量同步
python3 sync.py --full

# 简写形式
python3 sync.py -f
```

### 执行效果

```
正在获取表清单...
📋 发现 156 张表
🔧 同步模式: 强制全量同步
⚙️  并发线程数: 8
============================================================
🔄 mt_part: 强制全量同步 [✅ 成功]
🔄 mt_bom: 强制全量同步 [✅ 成功]
🔄 mt_classification: 强制全量同步 [✅ 成功]
... (更多表)
============================================================
🎉 所有任务结束。
```

## 🔍 工作原理

1. **获取所有表**: 自动从源数据库获取所有表名
2. **强制全量同步**: 对每个表执行 `WHERE 1=1`,同步所有数据
3. **更新 Checkpoint**: 如果表有 `editTime` 字段,同步成功后会更新 checkpoint
4. **并发执行**: 使用多线程并发处理,提高效率

## 📊 命令对比

| 命令 | 作用 | 适用场景 |
|------|------|----------|
| `python3 sync.py` | 所有表智能同步(增量) | 日常增量同步 |
| `python3 sync.py --full` | **所有表强制全量同步** | **数据库迁移/灾难恢复** |
| `python3 sync.py -t t1 t2` | 指定表智能同步(增量) | 只同步部分表 |
| `python3 sync.py -t t1 t2 -f` | 指定表强制全量同步 | 重置部分表数据 |

## 🎯 适用场景

### 1. 数据库迁移

从一个环境迁移到另一个环境:

```bash
# 将生产环境数据完整复制到测试环境
python3 sync.py --full
```

### 2. 灾难恢复

数据库出现问题,需要从备份恢复:

```bash
# 从备份服务器完整恢复所有数据
python3 sync.py --full
```

### 3. 环境复制

创建新的开发/测试环境:

```bash
# 将主环境数据复制到新环境
python3 sync.py --full
```

### 4. 数据重置

重置所有表的数据:

```bash
# 清空并重新同步所有数据
python3 sync.py --full
```

## ⚠️ 注意事项

### 1. 执行时间

- 所有表全量同步可能需要**较长时间**
- 建议在**非高峰期**执行
- 可以通过调整 `MAX_WORKERS` 来控制并发数

### 2. 存储空间

- 确保目标数据库有**足够的存储空间**
- 全量同步会传输大量数据

### 3. 网络带宽

- 需要**稳定的网络连接**
- 大量数据传输可能占用较多带宽

### 4. 数据库负载

- 会对源数据库和目标数据库产生**较大负载**
- 建议在低峰期执行

## 💡 最佳实践

### 1. 执行前检查

```bash
# 检查磁盘空间
df -h

# 检查数据库连接
mysql -h localhost -u root -p -e "SELECT 1"

# 检查表数量
mysql -h 10.11.252.103 -P 33306 -u root -p -e "USE meicloud_plm; SHOW TABLES;" | wc -l
```

### 2. 执行时监控

```bash
# 在另一个终端监控日志
tail -f sync.log

# 监控数据库连接数
watch -n 5 'mysql -u root -p123456 -e "SHOW PROCESSLIST"'
```

### 3. 执行后验证

```bash
# 检查同步结果
grep "成功" sync.log | wc -l
grep "失败" sync.log

# 检查 checkpoint
cat checkpoint.json | jq .
```

## 🔧 性能优化

### 1. 调整并发线程数

根据服务器性能调整:

```python
# 在 sync.py 中修改
MAX_WORKERS = 16  # 高性能服务器
MAX_WORKERS = 4   # 低配置服务器
```

### 2. 调整 DataX 通道数

```python
"setting": {
    "speed": {"channel": 10}  # 增加通道数
}
```

### 3. 分批执行

如果表太多,可以分批执行:

```bash
# 第一批
python3 sync.py -t table1 table2 table3 -f

# 第二批
python3 sync.py -t table4 table5 table6 -f
```

## 📈 执行时间估算

假设:
- 表数量: 150 张
- 平均每表数据量: 10MB
- 网络速度: 100Mbps
- 并发线程数: 8

**估算时间**: 约 20-30 分钟

实际时间取决于:
- 数据量大小
- 网络速度
- 服务器性能
- 并发线程数

## 🆚 与其他方式对比

| 方式 | 优点 | 缺点 |
|------|------|------|
| `sync.py --full` | 自动化、可恢复、有日志 | 需要 DataX |
| `mysqldump` | 简单、标准工具 | 锁表、不支持增量 |
| 手动导出/导入 | 灵活 | 繁琐、易出错 |
| 主从复制 | 实时同步 | 配置复杂 |

## 📚 相关文档

- [README.md](README.md) - 完整功能文档
- [QUICKSTART.md](QUICKSTART.md) - 快速开始指南

## ❓ 常见问题

### Q1: 执行时间太长怎么办?

A: 可以尝试:
1. 增加 `MAX_WORKERS` 并发数
2. 增加 DataX 通道数
3. 分批执行
4. 在网络条件更好的时段执行

### Q2: 中途失败了怎么办?

A: 
1. 查看错误日志 `error_*.log`
2. 修复问题后重新执行 `python3 sync.py --full`
3. 已成功的表不会重复同步(除非使用 `--full`)

### Q3: 如何只同步部分表?

A: 使用 `--tables` 参数:
```bash
python3 sync.py --tables table1 table2 --full
```

### Q4: 会删除目标库的数据吗?

A: 不会删除,使用的是 `REPLACE` 模式,会根据主键/唯一键更新或插入

### Q5: 可以定时执行吗?

A: 可以,但不建议定时全量同步,建议使用增量同步:
```bash
# 每天凌晨 2 点增量同步
0 2 * * * cd /path/to/PullData && python3 sync.py >> sync.log 2>&1
```

## 🎉 总结

**所有表全量同步**功能为您提供了一个强大的工具,可以快速、可靠地完成数据库迁移、灾难恢复等任务。

**核心命令**:
```bash
python3 sync.py --full
```

**记住**: 这是一个强大的功能,请谨慎使用,建议在非高峰期执行!
